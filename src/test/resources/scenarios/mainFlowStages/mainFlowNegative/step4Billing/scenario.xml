<scenario xmlns="http://www.knubisoft.com/e2e/testing/model/scenario" variations="billingN.csv">

    <overview>
        <description>Check ability successful registration on "pme"</description>
        <name>Registration main flow</name>
    </overview>

    <tags>
        <tag>Frontend</tag>
    </tags>

    <migrate comment="Add public pages" alias="central">
        <patches>central_required.sql</patches>
        <patches>central_email_templates.sql</patches>
    </migrate>

    <http comment="Clear cash for successful start scenario"
          alias="api">
        <post url="/api/v1/cache/invalidate"/>
    </http>

    <click comment="Click on Registration button"
           locatorId="mainPage.register"/>

    <input comment="Input first name"
           locatorId="ownerRegistration.firstName"
           value="Robert"/>

    <input comment="Input lastname"
           locatorId="ownerRegistration.lastName"
           value="Roberto"/>

    <input comment="Input email"
           locatorId="ownerRegistration.emailAddress"
           value="robert@gmail.com"/>

    <input comment="Input password"
           locatorId="ownerRegistration.password"
           value="Firm@nino19"/>

    <input comment="Input repeat password"
           locatorId="ownerRegistration.repPassword"
           value="Firm@nino19"/>

    <click comment="Click on 'confirm' 'Terms of use' and 'Privacy Policy' button"
           locatorId="ownerRegistration.confirm"/>

    <click comment="Click on 'Register account' button"
           locatorId="ownerRegistration.regAccount"
           method="js"/>

    <wait comment="Waiting of loading the 2Fa auth page"
          time="3"
          unit="seconds"/>

    <assert comment="Go to confirm email address page"
            locatorId="ownerRegistration.positiveAssertOwner"
            attribute="id">
        <content>home_header_button</content>
    </assert>

    <postgres comment="Get token and user_id from t_one_time_token table"
              alias="central"
              file="expected_13.json">
        <query>SELECT token, user_id FROM t_temp_user_one_time_token ORDER BY ID DESC LIMIT 1</query>
    </postgres>

    <var comment="Created token var" name="TOKEN">
        <jpath>$.[0].content.[0].token</jpath>
    </var>

    <var comment="Created user id var" name="USER_ID">
        <jpath>$.[0].content.[0].user_id</jpath>
    </var>

    <navigateTo comment="Emulate press on verify link button on email"
                path="/register/phone-verify/{{TOKEN}}"/>

    <assert comment="Make sure that the transition to the 2Fa page was successful"
            locatorId="ownerRegistration.positiveAssertOwner"
            attribute="id">
        <content>home_header_button</content>
    </assert>


    <click comment="Click on select country"
           locatorId="twoFactor.selectCountryFa"/>

    <click comment="Select Ukraine"
           locatorId="twoFactor.selectUkraine"/>

    <input highlight="false"
           comment="Input phone number"
           locatorId="twoFactor.phoneNumber"
           value="0679647221"/>

    <click comment="Click on 'Send code'"
           locatorId="twoFactor.sandCode"/>

    <wait comment="Waiting to process a completed database request"
          time="6"
          unit="seconds"/>

    <postgres comment="Get token and user_id from t_one_time_token table"
              alias="central"
              file="expected_23.json">
        <query>SELECT token, user_id FROM t_temp_user_one_time_token ORDER BY ID DESC LIMIT 1</query>
    </postgres>

    <var comment="Created token var" name="ORIGINAL_TOKEN">
        <jpath>$.[0].content.[0].token</jpath>
    </var>

    <var comment="Created token var" name="TOKEN">
        <value>"{{ORIGINAL_TOKEN}}"</value>
    </var>

    <var comment="Variable expression result" name="firstTokenDigit">
        <expression>{{TOKEN}}.toString().charAt(0)</expression>
    </var>

    <var comment="Variable expression result" name="secondTokenDigit">
        <expression>{{TOKEN}}.toString().charAt(1)</expression>
    </var>

    <var comment="Variable expression result" name="thirdTokenDigit">
        <expression>{{TOKEN}}.toString().charAt(2)</expression>
    </var>

    <var comment="Variable expression result" name="fourthTokenDigit">
        <expression>{{TOKEN}}.toString().charAt(3)</expression>
    </var>

    <var comment="Variable expression result" name="fifthTokenDigit">
        <expression>{{TOKEN}}.toString().charAt(4)</expression>
    </var>

    <var comment="Variable expression result" name="sixthTokenDigit">
        <expression>{{TOKEN}}.toString().charAt(5)</expression>
    </var>

    <var comment="Created user id var" name="USER_ID">
        <jpath>$.[0].content.[0].user_id</jpath>
    </var>

    <wait comment="Wait 5 seconds before starting set values in fields"
          time="5"
          unit="seconds"/>

    <input comment="Input verification code1"
           locatorId="twoFactor.enterCode1"
           value="{{firstTokenDigit}}"/>

    <input comment="Input verification code2"
           locatorId="twoFactor.enterCode2"
           value="{{secondTokenDigit}}"/>

    <input comment="Input verification code3"
           locatorId="twoFactor.enterCode3"
           value="{{thirdTokenDigit}}"/>

    <input comment="Input verification code4"
           locatorId="twoFactor.enterCode4"
           value="{{fourthTokenDigit}}"/>

    <input comment="Input verification code5"
           locatorId="twoFactor.enterCode5"
           value="{{fifthTokenDigit}}"/>

    <input comment="Input verification code6"
           locatorId="twoFactor.enterCode6"
           value="{{sixthTokenDigit}}"/>

    <wait comment="Wait one second for a request to check the correct response code"
          time="1" unit="seconds"/>

    <click comment="Click on Sand password button"
           locatorId="twoFactor.sandPass"/>

    <wait comment="Waiting 1 second for loaded field name-input"
          time="1"
          unit="seconds"/>

    <assert comment="Make sure that after the correct entered data, the transition to the 'Firm registration' page is completed'"
            locatorId="twoFactor.assertPositiveTwoFa"
            attribute="id">
        <content>register_firm-registration-name_input</content>
    </assert>

    <input comment="Input 'Firm Name'"
           locatorId="firmRegistration.firmName"
           value="Lawyer | Lawyer"/>

    <click comment=" Click to Select country"
           locatorId="firmRegistration.country"/>

    <wait comment="Loading select input country"
          time="2" unit="seconds"/>

    <click comment="Select United States"
           locatorId="firmRegistration.selectCountry"/>

    <click comment="Click to Select City"
           locatorId="firmRegistration.city"/>

    <wait comment="Loading select input city"
          time="2" unit="seconds"/>

    <click comment="Select California"
           locatorId="firmRegistration.selectCity"/>

    <click comment="Click to Select State"
           locatorId="firmRegistration.state"/>

    <wait comment="Loading select input state"
          time="4" unit="seconds"/>

    <click comment="Select State 'Los Angeles'"
           locatorId="firmRegistration.selectState"/>

    <input comment="Input Firm address1"
           locatorId="firmRegistration.firmAddress1"
           value="W Olympic Blvd Los Angeles"/>

    <input comment="Input Firm Address2"
           locatorId="firmRegistration.firmAddress2"
           value="W Olympic Blvd Los Angeles"/>

    <input comment="Input 'Postcode'"
           locatorId="firmRegistration.postcode"
           value="41456"/>

    <click comment="Click on 'Confirm' button"
           locatorId="firmRegistration.confirmFirm"/>

    <wait comment="Waiting for loading billing page"
          time="7 " unit="seconds"/>

    <assert comment="Checking the available, adding the value into the postcode field"
            locatorId="firmRegistration.firmRegisterPositiveAssert"
            attribute="id">
        <content>register_card_button</content>
    </assert>

    <input comment="Add card number"
           locatorId="billing.cardNumber"
           value="{{numberOfCard}}"/>

    <input comment="Add card name on card"
           locatorId="billing.nameOnCard"
           value="{{nameOnCard}}"/>

    <click comment="Choose 'exp date' month"
           locatorId="billing.expDateMonth"/>

    <wait comment="Loading select input Month"
          time="2" unit="seconds"/>

    <click comment="Choose month"
           locatorId="billing.january"/>

    <click comment="Choose 'exp date' Year"
           locatorId="billing.expDateYear"/>

    <wait comment="Loading select input City"
          time="2" unit="seconds"/>

    <click comment="Choose Year"
           locatorId="billing.chooseYear"/>

    <input comment="Add cvc code"
           locatorId="billing.cvc"
           value="{{cvc}}"/>

    <click comment="Click confirm button"
           locatorId="billing.confirmButton"/>

    <assert comment="We stay on this page after input incorrect card data"
            locatorId="billing.billingNegativeAssert"
            attribute="id">
        <content>register_card-number_input</content>
    </assert>

</scenario>

